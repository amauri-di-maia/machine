name: Brickovery - Bootstrap (M0)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

concurrency:
  group: brickovery-bootstrap-main
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Clone Brickovery repo manually (avoid actions/checkout post-step)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" repo
          cd repo
          git checkout "${BRANCH}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Git diagnostics (must be inside worktree)
        working-directory: repo
        run: |
          set -euo pipefail
          pwd
          git rev-parse --is-inside-work-tree
          git status --porcelain
          git remote -v

      - name: Clone upstream repo (read-only) into repo/upstream/amauri-repo
        env:
          UP_TOKEN: ${{ secrets.UPSTREAM_REPO_TOKEN }}
        run: |
          set -euo pipefail
          cd repo
          rm -rf upstream/amauri-repo || true
          mkdir -p upstream
          git clone "https://x-access-token:${UP_TOKEN}@github.com/amauri-di-maia/amauri-repo.git" upstream/amauri-repo
          cd upstream/amauri-repo
          git checkout f2727fe61be7990d8ef8188325493eec4f1f0ea0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: repo
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Preflight - verify required table files exist
        working-directory: repo
        run: |
          set -euo pipefail
          test -f "data/tables/shipping_normal.txt"
          test -f "data/tables/shipping_registered.txt"
          test -f "data/tables/rarity_rules.txt"
          echo "OK: table files exist"
          ls -la "data/tables"

      - name: Run bootstrap (M0) - no internal git sync
        working-directory: repo
        run: |
          set -euo pipefail
          python -m brickovery.cli bootstrap \
            --config configs/config.v1.yaml \
            --no-pull \
            --no-commit \
            --no-push

      - name: Git diagnostics (after bootstrap)
        working-directory: repo
        if: always()
        run: |
          set -euo pipefail
          pwd
          git rev-parse --is-inside-work-tree
          git status --porcelain
          git remote -v

      - name: Commit and push outputs (controlled)
        working-directory: repo
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Ensure origin uses token auth for push
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "brickovery: bootstrap (run_id=${{ github.run_id }})"
            git push origin "HEAD:${{ github.ref_name }}"
          else
            echo "No changes to commit."
          fi

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: brickovery-m0-debug
          path: |
            repo/data base/logs
            repo/data base/manifests
            repo/data base/brickovery.db
          if-no-files-found: warn
