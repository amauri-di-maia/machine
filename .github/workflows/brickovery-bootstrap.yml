name: Brickovery - Bootstrap (M0)

'on':
  workflow_dispatch:
    inputs:
      upstream_ref:
        description: "Upstream ref (branch/tag/commit SHA) to ingest"
        required: false
        default: "main"
  push:
    branches: ["main"]

concurrency:
  group: brickovery-bootstrap-main
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Clone Brickovery repo manually (avoid actions/checkout post-step)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" repo
          cd repo
          git checkout "${BRANCH}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: repo
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # Fallback minimal deps for M0/M1/M2
            pip install PyYAML pydantic requests beautifulsoup4
          fi
          sudo apt-get update
          sudo apt-get install -y sqlite3

      - name: Clone upstream repo (read-only) into repo/upstream/amauri-repo
        working-directory: repo
        env:
          UP_TOKEN: ${{ secrets.UPSTREAM_REPO_TOKEN }}
          UPSTREAM_REPO: amauri-di-maia/amauri-repo
          UPSTREAM_REF: ${{ inputs.upstream_ref }}
          GIT_LFS_SKIP_SMUDGE: "1"
        run: |
          set -euo pipefail
          rm -rf upstream/amauri-repo || true
          mkdir -p upstream

          git clone --depth 1 "https://x-access-token:${UP_TOKEN}@github.com/${UPSTREAM_REPO}.git" upstream/amauri-repo
          cd upstream/amauri-repo

          # Checkout the requested ref (default: main). Supports branch/tag/commit SHA.
          if [ -n "${UPSTREAM_REF:-}" ]; then
            git fetch --depth 1 origin "${UPSTREAM_REF}" || true
            git checkout -q "${UPSTREAM_REF}" || true
          fi

          UP_SHA="$(git rev-parse HEAD)"
          echo "UPSTREAM_COMMIT_SHA=${UP_SHA}" >> "${GITHUB_ENV}"
          echo "UPSTREAM_REF_USED=${UPSTREAM_REF:-}" >> "${GITHUB_ENV}"

          DB_PATH="data base/brickovery.db"
          test -f "${DB_PATH}"
          ls -la "${DB_PATH}"

          # Validate that the upstream file is a real SQLite DB (not LFS pointer / HTML / corrupt)
          python - <<'PY'
          from pathlib import Path
          p = Path("data base/brickovery.db")
          head = p.read_bytes()[:64]
          if head.startswith(b"version https://git-lfs.github.com/spec/v1"):
              raise SystemExit("ERROR: upstream brickovery.db is a Git LFS pointer. Re-upload it as a normal file (no LFS) on the upstream ref/branch.")
          if not head.startswith(b"SQLite format 3 "):
              sample = head.decode("utf-8", errors="replace").replace("
"," ").replace("
"," ")
              raise SystemExit(f"ERROR: upstream brickovery.db is not SQLite. head_sample={sample!r}")
          print("OK: upstream DB header is SQLite.")
          PY

          DB_SHA="$(python - <<'PY'
          import hashlib
          from pathlib import Path
          p = Path("data base/brickovery.db")
          h = hashlib.sha256()
          with p.open("rb") as f:
              for chunk in iter(lambda: f.read(1024*1024), b""):
                  h.update(chunk)
          print(h.hexdigest())
          PY
          )"
          echo "UPSTREAM_DB_SHA256=${DB_SHA}" >> "${GITHUB_ENV}"
          echo "upstream_commit_sha=${UP_SHA}"
          echo "upstream_db_sha256=${DB_SHA}"

      - name: Build runtime config (pin upstream ref for this run)
        working-directory: repo
        run: |
          set -euo pipefail
          python - <<'PY'
          from pathlib import Path
          import yaml

          src = Path("configs/config.v1.yaml")
          cfg = yaml.safe_load(src.read_text(encoding="utf-8")) or {}
          up = cfg.get("upstream") or {}
          # Always use the same ref the workflow checked out (default: main)
          up["ref"] = "${{ inputs.upstream_ref }}"
          cfg["upstream"] = up

          out = Path("configs/config.runtime.yaml")
          out.write_text(yaml.safe_dump(cfg, sort_keys=False, allow_unicode=True), encoding="utf-8")
          print("Wrote", out)
          PY

      - name: Run M0 bootstrap
        working-directory: repo
        run: |
          set -euo pipefail
          export PYTHONPATH="$PWD"
          python -m brickovery.cli bootstrap --config configs/config.runtime.yaml

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: brickovery-m0
          path: |
            repo/data base/brickovery.db
            repo/data base/logs
            repo/outputs
          if-no-files-found: warn
