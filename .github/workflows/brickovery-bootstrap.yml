name: Brickovery - Bootstrap (M0)

'on':
  workflow_dispatch:
    inputs:
      upstream_ref:
        description: "Upstream ref (branch/tag/commit SHA) to ingest"
        required: false
        default: "main"
  push:
    branches: ["main"]

concurrency:
  group: brickovery-bootstrap-main
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Clone Brickovery repo manually (avoid actions/checkout post-step)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" repo
          cd repo
          git checkout "${BRANCH}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: repo
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update
          sudo apt-get install -y sqlite3

      - name: Clone upstream repo (read-only) into repo/upstream/amauri-repo
        working-directory: repo
        env:
          UP_TOKEN: ${{ secrets.UPSTREAM_REPO_TOKEN }}
          UPSTREAM_REPO: amauri-di-maia/amauri-repo
          UPSTREAM_REF: ${{ inputs.upstream_ref }}
        run: |
          set -euo pipefail
          rm -rf upstream/amauri-repo || true
          mkdir -p upstream

          # Full clone for reliability (commit SHA refs work reliably)
          git clone "https://x-access-token:${UP_TOKEN}@github.com/${UPSTREAM_REPO}.git" upstream/amauri-repo
          cd upstream/amauri-repo

          if [ -n "${UPSTREAM_REF:-}" ] && [ "${UPSTREAM_REF}" != "main" ]; then
            git checkout -q "${UPSTREAM_REF}" || (git fetch --all --tags && git checkout -q "${UPSTREAM_REF}")
          fi

          test -f "data base/brickovery.db"
          echo "OK: upstream DB present"
          file "data base/brickovery.db" || true

      - name: Run M0 bootstrap
        working-directory: repo
        run: |
          set -euo pipefail
          export PYTHONPATH="$PWD"
          python -m brickovery.cli bootstrap --config configs/config.v1.yaml

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: brickovery-m0
          path: |
            repo/data base/brickovery.db
            repo/data base/logs
            repo/outputs
          if-no-files-found: warn
