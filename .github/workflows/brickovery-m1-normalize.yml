name: Brickovery - M1 Normalize Input

on:
  workflow_dispatch:

concurrency:
  group: brickovery-m1-main
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  normalize:
    runs-on: ubuntu-latest

    steps:
      - name: Clone repo manually
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" repo
          cd repo
          git checkout "${BRANCH}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: repo
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify + diagnose inputs/search.xml
        working-directory: repo
        run: |
          set -euo pipefail
          echo "== inputs dir =="
          ls -la inputs || true
          echo "== ensure file exists =="
          test -f inputs/search.xml
          echo "== bytes =="
          wc -c inputs/search.xml
          echo "== first 2000 bytes =="
          head -c 2000 inputs/search.xml || true
          echo
          echo "== last 2000 bytes =="
          tail -c 2000 inputs/search.xml || true
          echo

      - name: Run M1 normalize-input
        working-directory: repo
        run: |
          set -euo pipefail
          python -m brickovery.cli normalize-input \
            --config configs/config.v1.yaml \
            --input inputs/search.xml \
            --output-dir outputs/inputs

      - name: Post-M1 sanity (schema + fill_later sample, no assumptions)
        working-directory: repo
        run: |
          set -euo pipefail
          python - <<'PY'
          import sqlite3

          db = "data base/brickovery.db"
          con = sqlite3.connect(db)
          con.row_factory = sqlite3.Row

          def table_exists(name: str) -> bool:
              return con.execute(
                  "SELECT 1 FROM sqlite_master WHERE type='table' AND name=?",
                  (name,),
              ).fetchone() is not None

          def table_cols(name: str):
              return [r["name"] for r in con.execute(f"PRAGMA table_info('{name}')")]

          print("== tables ==")
          tables = [r["name"] for r in con.execute("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name")]
          print("\n".join(tables))

          for t in ["mapping_overrides", "up_mapping_mirror"]:
              print(f"\n== {t} schema ==")
              if not table_exists(t):
                  print("MISSING TABLE")
                  continue
              for r in con.execute(f"PRAGMA table_info('{t}')"):
                  print(dict(r))

          if not table_exists("mapping_overrides"):
              print("\n== fill_later check ==\nSKIP: mapping_overrides missing")
              con.close()
              raise SystemExit(0)

          cols = table_cols("mapping_overrides")
          if "status" not in cols:
              print("\n== fill_later check ==\nSKIP: mapping_overrides has no 'status' column")
              print("columns:", cols)
              con.close()
              raise SystemExit(0)

          n = con.execute("SELECT COUNT(*) AS n FROM mapping_overrides WHERE status='fill_later'").fetchone()["n"]
          print("\n== fill_later rows ==")
          print("count:", n)

          preferred = [
              "bl_itemtype", "item_type",
              "bl_part_id", "part_id",
              "bl_color_id", "color_id",
              "bo_boid", "boid",
              "status", "reason",
              "created_ts", "updated_ts",
          ]
          show = [c for c in preferred if c in cols]
          if not show:
              show = cols[:8]

          order_col = None
          for candidate in ["created_ts", "updated_ts", "rowid"]:
              if candidate == "rowid":
                  order_col = "rowid"
                  break
              if candidate in cols:
                  order_col = candidate
                  break

          sql = f"SELECT {', '.join(show)} FROM mapping_overrides WHERE status='fill_later'"
          if order_col:
              sql += f" ORDER BY {order_col} DESC"
          sql += " LIMIT 10"

          rows = con.execute(sql).fetchall()
          print("\n== sample fill_later rows ==")
          print("columns:", show)
          for r in rows:
              print({k: r[k] for k in show})

          con.close()
          PY

      - name: Commit and push outputs (controlled)
        working-directory: repo
        run: |
          set -euo pipefail
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "brickovery: M1 normalize-input (run_id=${{ github.run_id }})"
            git push origin "HEAD:${{ github.ref_name }}"
          else
            echo "No changes to commit."
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: brickovery-m1
          path: |
            repo/outputs/inputs
            repo/data base/logs
            repo/data base/manifests
            repo/data base/brickovery.db
          if-no-files-found: warn
