name: Brickovery - M1 Normalize Input

on:
  workflow_dispatch:

concurrency:
  group: brickovery-m1-main
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  normalize:
    runs-on: ubuntu-latest

    steps:
      - name: Clone repo manually
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" repo
          cd repo
          git checkout "${BRANCH}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: repo
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify input exists
        working-directory: repo
        run: |
          set -euo pipefail
          ls -la inputs || true
          test -f inputs/search.xml

      - name: Run M1 normalize-input
        working-directory: repo
        run: |
          set -euo pipefail
          python -m brickovery.cli normalize-input \
            --config configs/config.v1.yaml \
            --input inputs/search.xml \
            --output-dir outputs/inputs

      - name: Post-M1 sanity (schema + fill_later sample, no assumptions)
        working-directory: repo
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y sqlite3

          DB="data base/brickovery.db"

          echo "== tables =="
          sqlite3 "$DB" ".tables"

          echo "== mapping_overrides schema =="
          sqlite3 "$DB" "PRAGMA table_info('mapping_overrides');"

          echo "== up_mapping_mirror schema =="
          sqlite3 "$DB" "PRAGMA table_info('up_mapping_mirror');"

          echo "== fill_later count (if column exists) =="
          python - <<'PY'
          import sqlite3

          db = "data base/brickovery.db"
          con = sqlite3.connect(db)
          con.row_factory = sqlite3.Row

          def cols(table):
              return [r["name"] for r in con.execute(f"PRAGMA table_info('{table}')")]

          tables = [
              r["name"]
              for r in con.execute("SELECT name FROM sqlite_master WHERE type='table'")
          ]

          if "mapping_overrides" not in tables:
              print("mapping_overrides table does not exist.")
              raise SystemExit(0)

          c = cols("mapping_overrides")
          if "status" not in c:
              print("mapping_overrides has no 'status' column. Columns:", c)
              raise SystemExit(0)

          n = con.execute(
              "SELECT COUNT(*) AS n FROM mapping_overrides WHERE status='fill_later'"
          ).fetchone()["n"]
          print("fill_later rows:", n)

          # escolher colunas “melhor esforço” para mostrar
          preferred = [
              "bl_itemtype",
              "item_type",
              "bl_part_id",
              "part_id",
              "bl_color_id",
              "color_id",
              "bo_boid",
              "boid",
              "status",
              "reason",
              "created_ts",
              "updated_ts",
          ]
          show = [x for x in preferred if x in c]
          if not show:
              show = c[:8]  # fallback

          sql = (
              "SELECT "
              + ", ".join(show)
              + " FROM mapping_overrides WHERE status='fill_later' "
              + " ORDER BY created_ts DESC LIMIT 10"
          )
          rows = con.execute(sql).fetchall()

          print("== sample fill_later rows ==")
          print("columns:", show)
          for r in rows:
              print({k: r[k] for k in show})

          con.close()
          PY

      - name: Commit and push outputs (controlled)
        working-directory: repo
        run: |
          set -euo pipefail
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "brickovery: M1 normalize-input (run_id=${{ github.run_id }})"
            git push origin "HEAD:${{ github.ref_name }}"
          else
            echo "No changes to commit."
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: brickovery-m1
          path: |
            repo/outputs/inputs
            repo/data base/logs
            repo/data base/manifests
            repo/data base/brickovery.db
          if-no-files-found: warn
          
