name: Brickovery - M2 Refresh Market Cache

on:
  workflow_dispatch:

concurrency:
  group: brickovery-m2-main
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  m2:
    runs-on: ubuntu-latest

    steps:
      - name: Clone repo manually
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" repo
          cd repo
          git checkout "${BRANCH}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Clone upstream repo (read-only)
        working-directory: repo
        env:
          UP_TOKEN: ${{ secrets.UPSTREAM_REPO_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p upstream
          git clone "https://x-access-token:${UP_TOKEN}@github.com/amauri-di-maia/amauri-repo.git" upstream/amauri-repo

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: repo
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -c "import bs4; import requests; print('deps OK')"

      - name: Set RUN_ID
        run: echo "RUN_ID=$(date -u +%Y%m%dT%H%M%SZ)" >> $GITHUB_ENV

      - name: Verify inputs exist
        working-directory: repo
        run: |
          set -euo pipefail
          ls -la inputs || true
          test -f inputs/search.xml

      - name: M0 bootstrap
        working-directory: repo
        run: |
          set -euo pipefail
          python -m brickovery.cli bootstrap             --config configs/config.v1.yaml             --run-id "${RUN_ID}"             --slice-id "0"             --upstream-checkout-path upstream/amauri-repo             --no-pull             --no-commit             --no-push

      - name: M1 normalize-input
        working-directory: repo
        run: |
          set -euo pipefail
          python -m brickovery.cli normalize-input             --config configs/config.v1.yaml             --run-id "${RUN_ID}"             --slice-id "0"             --input inputs/search.xml             --output-dir outputs/inputs

      - name: M2 refresh-cache (TTL 6h, strict EU+ships-to-PT)
        working-directory: repo
        env:
          BRICKLINK_COOKIE: ${{ secrets.BRICKLINK_COOKIE }}
        run: |
          set -euo pipefail
          python -m brickovery.cli refresh-cache             --config configs/config.v1.yaml             --run-id "${RUN_ID}"             --slice-id "0"             --snapshot-id "${RUN_ID}"             --ttl-hours "6"             --cookie-env-var "BRICKLINK_COOKIE"             --normalized-items "outputs/inputs/normalized_items.${RUN_ID}.json"

      - name: Show last m2.error from jsonl logs
        if: always()
        working-directory: repo
        run: |
          set -euo pipefail
          echo "== last m2.error events (if any) =="
          if ls -1 "data base/logs"/*.jsonl >/dev/null 2>&1; then
            tail -n 400 "data base/logs"/*.jsonl | grep -F '"m2.error"' | tail -n 20 || true
          else
            echo "No jsonl logs found under data base/logs"
            find "data base" -maxdepth 3 -type f -name "*.jsonl" -print || true
          fi

      - name: BrickLink connectivity diagnostics (no secrets printed)
        if: always()
        working-directory: repo
        env:
          BRICKLINK_COOKIE: ${{ secrets.BRICKLINK_COOKIE }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, re, requests
          
          cookie = os.getenv("BRICKLINK_COOKIE", "").strip()
          
          s = requests.Session()
          h = {
              "User-Agent": "Mozilla/5.0",
              "Accept": "text/html, */*; q=0.01",
              "X-Requested-With": "XMLHttpRequest",
              "Referer": "https://www.bricklink.com/v2/main.page",
          }
          if cookie:
              h["Cookie"] = cookie
          else:
              print("NOTE: BRICKLINK_COOKIE is empty; running public connectivity checks only.")
          
          def req(name, url, *, params=None, timeout=25):
              try:
                  r = s.get(url, params=params, headers=h, timeout=timeout, allow_redirects=False)
                  loc = r.headers.get("Location")
                  body = (r.text or "")[:260].replace("\n", " ").replace("\r", " ")
                  print(f"[{name}] status={r.status_code} location={loc} url={r.url}")
                  print(f"[{name}] body_snip={body!r}")
                  return r
              except Exception as e:
                  print(f"[{name}] EXCEPTION: {e}")
                  return None
          
          # 0) main page (avoid redirect noise)
          req("main.page", "https://www.bricklink.com/v2/main.page")
          
          # 1) catalog item (public) to extract idItem
          r_item = req("catalogitem.page P=3005", "https://www.bricklink.com/v2/catalog/catalogitem.page", params={"P": "3005"})
          html = (r_item.text if r_item is not None else "") or ""
          
          m = (
              re.search(r"idItem\s*=\s*(\d+)", html)
              or re.search(r"idItem\s*:\s*(\d+)", html)
              or re.search(r'"idItem"\s*:\s*(\d+)', html)
              or re.search(r"idItem=(\d+)", html)
          )
          id_item = m.group(1) if m else None
          print(f"[catalogitem] parsed idItem={id_item!r}")
          
          if not id_item:
              print("ERROR: could not parse idItem from catalogitem.page HTML. This is often the root cause of M2 failures.")
          else:
              # 2) sold 6m (BASE_VALUE source)
              req(
                  "priceGuideSummary (sold6m)",
                  "https://www.bricklink.com/priceGuideSummary.asp",
                  params={"a": "P", "itemID": id_item, "colorID": "80", "vatInc": "Y", "vcID": "2"},
                  timeout=25,
              )
          
              # 3) current offers tab (st=1 new, st=2 used)
              for st in ("1", "2"):
                  req(
                      f"catalogitem_pgtab (offers st={st})",
                      "https://www.bricklink.com/v2/catalog/catalogitem_pgtab.page",
                      params={"idItem": id_item, "idColor": "80", "st": st, "showflag": "1", "currency": "2", "prec": "3"},
                      timeout=30,
                  )
          PY

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: brickovery-m2
          path: |
            repo/outputs/inputs
            repo/outputs/market
            repo/data base/logs
            repo/data base/manifests
            repo/data base/brickovery.db
          if-no-files-found: warn

      - name: Fail workflow if M2 refresh_report has errors
        if: always()
        working-directory: repo
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, glob, sys

          paths = sorted(glob.glob("outputs/market/refresh_report.*.json"))
          if not paths:
              print("ERROR: No outputs/market/refresh_report.*.json found")
              sys.exit(1)

          rp = paths[-1]
          with open(rp, "r", encoding="utf-8") as f:
              report = json.load(f)

          errors = int(report.get("errors", 0))
          refreshed = int(report.get("refreshed_items", 0))
          skipped = int(report.get("skipped_items", 0))

          print(f"refresh_report: {rp}")
          print(f"errors={errors} refreshed_items={refreshed} skipped_items={skipped}")

          if errors > 0:
              sys.exit(f"ERROR: M2 refresh-cache reported errors={errors}")
          PY

      - name: Commit and push (atomic)
        if: success()
        working-directory: repo
        run: |
          set -euo pipefail
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "brickovery: M2 refresh-cache (run_id=${RUN_ID})"
            git push origin "HEAD:${{ github.ref_name }}"
          else
            echo "No changes to commit."
          fi
