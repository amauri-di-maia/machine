name: Brickovery - Inspect Upstream DB (schema + fill rates)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  inspect:
    runs-on: ubuntu-latest

    steps:
      - name: Clone Brickovery repo (manual)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" repo
          cd repo
          git checkout "${BRANCH}"

      - name: Clone upstream repo (read-only)
        env:
          UP_TOKEN: ${{ secrets.UPSTREAM_REPO_TOKEN }}
        run: |
          set -euo pipefail
          cd repo
          rm -rf upstream/amauri-repo || true
          mkdir -p upstream
          git clone "https://x-access-token:${UP_TOKEN}@github.com/amauri-di-maia/amauri-repo.git" upstream/amauri-repo
          cd upstream/amauri-repo
          git checkout f2727fe61be7990d8ef8188325493eec4f1f0ea0

      - name: Build schema report (tables + candidate columns + non-null counts)
        run: |
          set -euo pipefail
          python - <<'PY'
          import sqlite3, os, re, textwrap

          db_path = "repo/upstream/amauri-repo/data base/brickovery.db"
          con = sqlite3.connect(db_path)
          con.row_factory = sqlite3.Row

          def tables():
            return [r["name"] for r in con.execute(
              "SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name;"
            )]

          def cols(t):
            return [r["name"] for r in con.execute(f"PRAGMA table_info('{t}');")]

          def nn_count(t, col, limit=80000):
            if not col: return 0
            q = f"""
              SELECT SUM(CASE WHEN {col} IS NOT NULL AND TRIM(CAST({col} AS TEXT))!='' THEN 1 ELSE 0 END) AS nn
              FROM (SELECT {col} FROM '{t}' LIMIT {limit});
            """
            try:
              return int(con.execute(q).fetchone()["nn"] or 0)
            except Exception:
              return 0

          def pick(columns, keys):
            for c in columns:
              cl = c.lower()
              if any(k in cl for k in keys):
                return c
            return None

          candidates = []
          for t in tables():
            c = cols(t)
            low = [x.lower() for x in c]

            # Só considerar tabelas que tenham “sinais” fortes
            if not any("boid" in x or "brickowl" in x for x in low) and not any("weight" in x or "gram" in x or "mass" in x for x in low):
              continue

            boid_col = pick(c, ["boid"])
            w_col    = pick(c, ["weight"])
            bl_part  = pick(c, ["bl_part_id"])
            bl_color = pick(c, ["bl_color_id"])
            it_type  = pick(c, ["item_type"])

            nn_boid = nn_count(t, boid_col)
            nn_w    = nn_count(t, w_col)

            score = 0
            score += 10 if nn_boid > 0 else 0
            score += 5  if nn_w > 0 else 0
            score += 2  if bl_part else 0
            score += 1  if bl_color else 0
            score += 1  if it_type else 0

            candidates.append((score, nn_boid, nn_w, t, boid_col, w_col, bl_part, bl_color, it_type, c))

          candidates.sort(reverse=True)

          out = []
          out.append("UPSTREAM SCHEMA REPORT")
          out.append(f"db_path: {db_path}")
          out.append("")
          out.append("TOP CANDIDATES (ordered by score, then nn_boid, then nn_weight):")
          out.append("format: score | nn_boid(sample) | nn_weight(sample) | table | boid_col | weight_col | bl_part_col | bl_color_col | bl_itemtype_col")
          out.append("-"*120)

          for score, nn_boid, nn_w, t, boid_col, w_col, bl_part, bl_color, it_type, c in candidates[:25]:
            out.append(f"{score:>5} | {nn_boid:>14} | {nn_w:>16} | {t} | {boid_col} | {w_col} | {bl_part} | {bl_color} | {it_type}")

          out.append("")
          out.append("NOTE: 'sample' counts are on the first 80k rows (enough to detect real fill).")
          out.append("")

          os.makedirs("repo/data base", exist_ok=True)
          with open("repo/data base/upstream_schema_report.txt", "w", encoding="utf-8") as f:
            f.write("\n".join(out) + "\n")

          con.close()
          PY

      - name: Upload schema report
        uses: actions/upload-artifact@v4
        with:
          name: upstream-schema-report
          path: repo/data base/upstream_schema_report.txt
          if-no-files-found: error
