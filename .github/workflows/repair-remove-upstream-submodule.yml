name: Repair - Remove submodule gitlinks (no checkout)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  repair:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repo manually and repair gitlinks
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" repo
          cd repo
          git checkout "${BRANCH}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          echo "== Gitlinks (mode 160000) BEFORE =="
          git ls-files --stage | awk '$1=="160000"{print}' || true

          # Remove any gitlink under upstream/ (covers upstream/amauri-repo and any future accidental entries)
          while read -r mode sha stage path; do
            if [ "${mode}" = "160000" ] && [[ "${path}" == upstream/* ]]; then
              echo "Removing gitlink: ${path}"
              git rm --cached -f "${path}" || true
            fi
          done < <(git ls-files --stage)

          echo "== .gitmodules cleanup (only upstream entries) =="
          if [ -f .gitmodules ]; then
            # remove all sections that point to upstream/*
            # (safe even if they don't exist)
            while read -r key; do
              section="${key#submodule.}"
              section="${section%.path}"
              subpath="$(git config -f .gitmodules --get "${key}" || true)"
              if [[ "${subpath}" == upstream/* ]]; then
                echo "Removing .gitmodules section: ${section}"
                git config -f .gitmodules --remove-section "${section}" || true
              fi
            done < <(git config -f .gitmodules --name-only --get-regexp '^submodule\..*\.path$' || true)

            # remove file if empty
            if ! git config -f .gitmodules --name-only --get-regexp '^submodule\.' >/dev/null 2>&1; then
              rm -f .gitmodules
            fi
            git add .gitmodules || true
          fi

          echo "== Ignore upstream/ folder =="
          mkdir -p upstream
          grep -qxF "/upstream/" .gitignore 2>/dev/null || echo "/upstream/" >> .gitignore
          git add .gitignore

          echo "== Gitlinks (mode 160000) AFTER =="
          git ls-files --stage | awk '$1=="160000"{print}' || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Repair: remove upstream submodule gitlinks and ignore upstream/"
          git push origin "HEAD:${BRANCH}"
