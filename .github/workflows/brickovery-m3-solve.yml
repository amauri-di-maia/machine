name: Brickovery - M3 Solve Seeds

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Shipping mode to score (normal|registered|both)"
        required: true
        default: "both"

jobs:
  solve:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install PyYAML pydantic beautifulsoup4 requests
          sudo apt-get update
          sudo apt-get install -y sqlite3

      - name: Set RUN_ID
        run: |
          set -euo pipefail
          echo "RUN_ID=$(date -u +%Y%m%dT%H%M%SZ)" >> $GITHUB_ENV

      - name: Normalize input (M1)
        run: |
          set -euo pipefail
          export PYTHONPATH="$PWD"
          python -m brickovery.cli normalize-input             --config configs/config.v1.yaml             --input inputs/search.xml             --output-dir outputs/inputs

      - name: Resolve latest normalized_items + snapshot_id from DB
        run: |
          set -euo pipefail
          latest_norm="$(ls -1t outputs/inputs/normalized_items.*.json | head -n 1)"
          echo "LATEST_NORM=$latest_norm" >> $GITHUB_ENV
          echo "latest_norm=$latest_norm"

          # Pick most-recent snapshot present in DB (M2 already populated offers/metrics)
          snap="$(sqlite3 "data base/brickovery.db" "
            SELECT snapshot_id
            FROM (
              SELECT snapshot_id, fetched_ts FROM market_offers
              UNION ALL
              SELECT snapshot_id, fetched_ts FROM market_metrics
            )
            ORDER BY fetched_ts DESC, snapshot_id DESC
            LIMIT 1;
          ")"

          if [ -z "$snap" ]; then
            echo "ERROR: Could not resolve snapshot_id from DB (market_offers/market_metrics empty)."
            echo "Action: Run M2 refresh-cache (force once after changing search.xml) then re-run M3."
            exit 1
          fi

          offers="$(sqlite3 "data base/brickovery.db" "SELECT COUNT(*) FROM market_offers WHERE snapshot_id='$snap';")"
          metrics="$(sqlite3 "data base/brickovery.db" "SELECT COUNT(*) FROM market_metrics WHERE snapshot_id='$snap';")"
          echo "SNAPSHOT_ID=$snap" >> $GITHUB_ENV
          echo "snapshot_id=$snap offers_rows=$offers metrics_rows=$metrics"

          if [ "$offers" -eq 0 ] && [ "$metrics" -eq 0 ]; then
            echo "ERROR: snapshot_id resolved but has 0 rows in both market_offers and market_metrics."
            echo "Action: Re-run M2 refresh-cache (with --force once) and ensure it writes to the same DB."
            exit 1
          fi

      - name: Run M3 solve (seed scenarios)
        run: |
          set -euo pipefail
          export PYTHONPATH="$PWD"
          python -m brickovery.cli solve             --config configs/config.v1.yaml             --normalized-items "$LATEST_NORM"             --snapshot-id "$SNAPSHOT_ID"             --mode "${{ inputs.mode }}"

      - name: Upload artifacts (debug)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: brickovery-m3-artifacts-${{ env.RUN_ID }}
          path: |
            outputs/inputs/**
            outputs/solve/**
            outputs/market/**
            data base/logs/**
