name: Brickovery - M2 Refresh Cache

on:
  workflow_dispatch:
    inputs:
      force:
        description: "Force refresh (ignore TTL once)"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]
      commit_push:
        description: "Commit & push DB + reports to repo (required for M3 to see data)"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]

concurrency:
  group: brickovery-m2
  cancel-in-progress: false

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (minimal)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install pydantic PyYAML beautifulsoup4 requests

      - name: Verify inputs exist
        run: |
          set -euo pipefail
          ls -la inputs || true
          test -f "inputs/search.xml"

      - name: Normalize input (M1 inside M2)
        run: |
          set -euo pipefail
          export PYTHONPATH="$PWD"
          mkdir -p outputs/inputs
          python -m brickovery.cli normalize-input             --config configs/config.v1.yaml             --input inputs/search.xml             --output-dir outputs/inputs

      - name: Refresh cache (M2)
        run: |
          set -euo pipefail
          export PYTHONPATH="$PWD"
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            FORCE_FLAG="--force"
          fi
          python -m brickovery.cli refresh-cache             --config configs/config.v1.yaml             $FORCE_FLAG

      - name: DB gate (must have offers + metrics)
        run: |
          set -euo pipefail
          python - <<'PY'
          import sqlite3, os
          db = os.path.join("data base", "brickovery.db")
          con = sqlite3.connect(db)
          con.row_factory = sqlite3.Row
          def count(t):
            try:
              return con.execute(f"SELECT COUNT(*) AS n FROM {t}").fetchone()["n"]
            except Exception:
              return None
          offers = count("market_offers")
          metrics = count("market_metrics")
          print(f"market_offers.rows={offers}")
          print(f"market_metrics.rows={metrics}")
          if offers in (None, 0) or metrics in (None, 0):
            raise SystemExit("ERROR: DB gate failed (missing market_offers/market_metrics).")
          PY

      - name: Commit & push (required for M3)
        if: ${{ github.event.inputs.commit_push == 'true' }}
        run: |
          set -euo pipefail
          git config user.name "brickovery-bot"
          git config user.email "actions@users.noreply.github.com"

          # Add only what M3 needs to consume deterministically
          git add "data base/brickovery.db" || true
          git add outputs/inputs outputs/market || true

          # If nothing changed, do nothing
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "M2 refresh-cache (run_id=${{ github.run_id }})"
          git push
